<?php

namespace App\Http\Controllers;

use App\Http\Requests\ProfileUserUpdateRequest;
use App\Services\NotifyService;
use App\Traits\FileUploadTrait;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Auth;

class UserProfileController extends Controller
{
    use FileUploadTrait;

    public function update(Request $request): Response
    {
        $request->validate(
            [
                'avatar' => ['nullable', 'image', 'max:3000', 'mimes:png,jpg,jpeg,gif'],
                'name' => ['required', 'string', 'max:50'],
                'user_id' => ['required', 'string', 'max:50', 'unique:users,user_name,' . auth()->user()->id],
                'email' => ['required', 'email', 'max:100']
            ],
            [
                'avatar.image' => 'KhÃ´ng thá»ƒ chá»n file khÃ¡c, vui lÃ²ng chá»n file áº£nh.',
                'avatar.mimes' => 'áº¢nh pháº£i lÃ  file PNG | JPG | JPEG | GIF',

                'name.required' => 'Há» vÃ  tÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.',
                'name.string' => 'TÃªn pháº£i lÃ  chá»¯ khÃ´ng Ä‘Æ°á»£c cÃ³ sá»‘ hay kÃ½ tá»±.',
                'name.max' => 'Tá»‘i Ä‘a 50 kÃ½ tá»±.',

                'user_id.required' => 'TÃªn ngÆ°á»i dÃ¹ng khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.',
                'user_id.max' => 'Tá»‘i Ä‘a 50 kÃ½ tá»±.',
                'user_id.unique' => 'TÃªn ngÆ°á»i dÃ¹ng nÃ y Ä‘Ã£ tá»“n táº¡i.',

                'email.required' => 'Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.',
                'email.email' => 'Email khÃ´ng há»£p lá»‡.',
                'email.max' => 'Email khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 100 kÃ½ tá»±.'
            ]
        );

        $avatarPath = $this->uploadFile($request, 'avatar');
        $user = Auth::user();
        if ($avatarPath) $user->avatar = $avatarPath;
        $user->name = $request->name;
        $user->user_name = $request->user_id;
        $user->email = $request->email;

        if ($request->filled('current_password')) {
            $request->validate(
                [
                    'current_password' => ['required', 'current_password'],
                    'password' => ['required', 'confirmed', 'string', 'min:8']
                ],
                [
                    'current_password.required' => 'Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng',
                    'current_password.current_password' => 'Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng',

                    'password.required' => 'Máº­t kháº©u má»›i khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng',
                    'password.confirmed' => 'Máº­t kháº©u má»›i vÃ  xÃ¡c thá»±c máº­t kháº©u khÃ´ng trÃ¹ng khá»›p',
                    'password.min' => 'Máº­t kháº©u Ã­t nháº¥t 8 kÃ½ tá»±',
                ]
            );
            $user->password = bcrypt($request->password);
        }

        $user->save();

        NotifyService::SuccessNotification('Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng! ğŸ‰');

        return response(['message' => 'Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng! ğŸ‰'], 200);
    }
}
